name: Build and Deploy

on:
  push:
    branches:
      - main

jobs:
  build:
    name: Build, Analyze, and Deploy
    runs-on: self-hosted

    steps:
      # Checkout code
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Set  JDK 21
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'

      # Set up Maven
      - name: Set up Maven
        uses: stCarolas/setup-maven@v5
        with:
          maven-version: '3.9.9'

      # Build and SonarQube analysis
      - name: Build and analyze
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        run: |
          mvn -B clean verify sonar:sonar \
            -Dsonar.projectKey=quality-gate \
            -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
            -Dsonar.login=${{ secrets.SONAR_TOKEN }}

      # Pull base Docker 
      - name: Pull base Docker image
        run: |
          docker pull eclipse-temurin:21-jdk-alpine || \
          docker pull eclipse-temurin:21-jdk || \
          docker pull amazoncorretto:21-alpine
        continue-on-error: false

      # Build Docker image
      - name: Build Docker image
        run: |
          docker build -t zak1234/quality-gate:latest .
          docker tag zak1234/quality-gate:latest zak1234/quality-gate:${{ github.sha }}

      # Login to DockerHub
      - name: Log in to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Verify Docker login
      - name: Verify Docker authentication
        run: |
          echo "Logged in as: ${{ secrets.DOCKER_USERNAME }}"
          docker info | grep Username || echo "Warning: Username not found in docker info"

      # Push D 
      - name: Push Docker image
        run: |
          docker push zak1234/quality-gate:latest
          docker push zak1234/quality-gate:${{ github.sha }}

  # Setup kubeconfig
      # - name: Set up kubeconfig
      #   run: |
      #     mkdir -p $HOME/.kube
      #     echo "${{ secrets.KUBECONFIG_CONTENT }}" > $HOME/.kube/config
      #     chmod 600 $HOME/.kube/config
          
      #     # Debug: Show the kubeconfig structure
      #     echo "Kubeconfig structure:"
      #     kubectl config view
          
      #     # Check if contexts exist and have names
      #     CONTEXT_COUNT=$(kubectl config get-contexts -o name 2>/dev/null | wc -l)
          
      #     if [ "$CONTEXT_COUNT" -eq 0 ]; then
      #       echo "No valid contexts found in kubeconfig"
      #       echo "Attempting to fix kubeconfig..."
            
      #       # Get cluster and user info
      #       CLUSTER_NAME=$(kubectl config view -o jsonpath='{.clusters[0].name}')
      #       USER_NAME=$(kubectl config view -o jsonpath='{.users[0].name}')
            
      #       # Create a new context with a proper name
      #       kubectl config set-context default-context \
      #         --cluster="$CLUSTER_NAME" \
      #         --user="$USER_NAME" \
      #         --namespace=ensakh
            
      #       kubectl config use-context default-context
      #     else
      #       # Get the first valid context name
      #       CONTEXT_NAME=$(kubectl config get-contexts -o name | head -n 1)
      #       echo "Using existing context: $CONTEXT_NAME"
      #       kubectl config use-context "$CONTEXT_NAME"
      #       kubectl config set-context --current --namespace=ensakh
      #     fi
          
      #     echo "Current context set successfully"

      # # Verify Kubernetes connection
      # - name: Verify Kubernetes context
      #   run: |
      #     echo "Current context:"
      #     kubectl config current-context
      #     echo -e "\nCurrent namespace:"
      #     kubectl config view --minify --output 'jsonpath={..namespace}'
      #     echo -e "\n\nAvailable namespaces:"
      #     kubectl get namespaces
      #     echo -e "\nCluster info:"
      #     kubectl cluster-info

      # # Deploy to Kubernetes
      # - name: Deploy to Kubernetes
      #   run: |
      #     kubectl apply -f k8s/deployment.yaml
      #     kubectl rollout status deployment/quality-gate -n ensakh --timeout=5m

      # # Verify deployment
      # - name: Verify Kubernetes deployment
      #   run: |
      #     echo "Nodes:"
      #     kubectl get nodes
      #     echo -e "\nNamespaces:"
      #     kubectl get namespaces
      #     echo -e "\nPods in ensakh namespace:"
      #     kubectl get pods -n ensakh
      #     echo -e "\nServices in ensakh namespace:"
      #     kubectl get services -n ensakh
      #     echo -e "\nDeployment status:"
      #     kubectl get deployment quality-gate -n ensakh
      #     echo -e "\nDeployment details:"
      #     kubectl describe deployment quality-gate -n ensakh

      - name: Cleanup old Docker images
        if: success()
        run: |
          docker image prune -f --filter "until=24h"
        continue-on-error: true