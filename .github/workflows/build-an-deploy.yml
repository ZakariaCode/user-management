name: Build and Deploy

on:
  push:
    branches:
      - main

jobs:
  build:
    name: Build, Analyze, and Deploy
    runs-on: self-hosted

    steps:
      # Checkout code
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Set up JDK 21
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'

      # Set up Maven
      - name: Set up Maven
        uses: stCarolas/setup-maven@v5
        with:
          maven-version: '3.9.9'

      # Build and SonarQube analysis
      - name: Build and analyze
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        run: |
          mvn -B clean verify sonar:sonar \
            -Dsonar.projectKey=quality-gate \
            -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
            -Dsonar.login=${{ secrets.SONAR_TOKEN }}

      # Pull base Docker 
      - name: Pull base Docker image
        run: |
          docker pull eclipse-temurin:21-jdk-alpine || \
          docker pull eclipse-temurin:21-jdk || \
          docker pull amazoncorretto:21-alpine
        continue-on-error: false

      # Build Docker image
      - name: Build Docker image
        run: |
          docker build -t zak1234/quality-gate:latest .
          docker tag zak1234/quality-gate:latest zak1234/quality-gate:${{ github.sha }}

      # Login to DockerHub
      - name: Log in to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Verify Docker login
      - name: Verify Docker authentication
        run: |
          echo "Logged in as: ${{ secrets.DOCKER_USERNAME }}"
          docker info | grep Username || echo "Warning: Username not found in docker info"

      # Push D 
      - name: Push Docker image
        run: |
          docker push zak1234/quality-gate:latest
          docker push zak1234/quality-gate:${{ github.sha }}

  # Install K3s if not present (lightweight Kubernetes)
      - name: Setup K3s cluster
        run: |
          # Check if k3s is already installed
          if ! command -v k3s &> /dev/null; then
            echo "Installing K3s..."
            curl -sfL https://get.k3s.io | sh -s - --write-kubeconfig-mode 644
            
            # Wait for k3s to be ready
            echo "Waiting for K3s to be ready..."
            sleep 30
            sudo k3s kubectl wait --for=condition=Ready node --all --timeout=60s
          else
            echo "K3s already installed"
          fi
          
          # Setup kubeconfig
          mkdir -p $HOME/.kube
          sudo cp /etc/rancher/k3s/k3s.yaml $HOME/.kube/config
          sudo chown $(id -u):$(id -g) $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          
          # Update server to localhost
          sed -i 's/127.0.0.1/localhost/g' $HOME/.kube/config

      # Create namespace
      - name: Create namespace
        run: |
          kubectl create namespace ensakh --dry-run=client -o yaml | kubectl apply -f -
          kubectl config set-context --current --namespace=ensakh

      # Verify Kubernetes
      - name: Verify Kubernetes
        run: |
          echo "Cluster info:"
          kubectl cluster-info
          
          echo -e "\nNodes:"
          kubectl get nodes
          
          echo -e "\nNamespaces:"
          kubectl get namespaces
          
          echo -e "\nCurrent context:"
          kubectl config current-context

      # Deploy to Kubernetes
      - name: Deploy to Kubernetes
        run: |
          echo "Applying deployment..."
          kubectl apply -f k8s/deployment.yaml
          
          echo "Waiting for rollout..."
          kubectl rollout status deployment/quality-gate -n ensakh --timeout=5m

      # Verify deployment
      - name: Verify deployment
        run: |
          echo "Pods:"
          kubectl get pods -n ensakh
          
          echo -e "\nServices:"
          kubectl get services -n ensakh
          
          echo -e "\nDeployment:"
          kubectl get deployment quality-gate -n ensakh
          
          echo -e "\nDeployment details:"
          kubectl describe deployment quality-gate -n ensakh

      # Cleanup old images
      - name: Cleanup old Docker images
        if: success()
        run: |
          docker image prune -f --filter "until=24h"
        continue-on-error: true